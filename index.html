<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatting apps by zeru</title> 
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="main.css" type="text/css" media="all" />
  </head>
  <body>
     <nav class="navbar bg-light fixed-top navbar-expand-lg nav-top" style="box-shadow: -5px 0 5px rgba(0,0,0,.3);">
          <div class="container-fluid position-relative">
            <a class="navbar-brand nav-logo-text" href="#">Chatzer.</a>
            <div class="d-flex position-absolute justify-content-center align-items-center text-center gap-1" style="width:100%;height:20px;bottom:0;">
              <div style="width:10px; height:10px; border-radius:50%; background:#53f080; box-shadow:0 0 5px #53f080;"></div>
              <p class="mt-3" id="info-online">0/0 orang online</p>
            </div>
            <div class="d-flex gap-2">
            <button class="navbar-toggler m-0 navbar-top-btn" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation" style="border:0 !important;">
              <i class="bi bi-list display-4" style="border:0 !important; color:#000 !important;"></i>
            </button>
            </div>
            <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
              <div class="navbar-nav py-2 gap-2">
                <a onclick="window.location.href = '/'" class="nav-link active nav-active d-flex align-items-center" aria-current="page" href="#">
                <i class="bi i-nav bi-house"></i>Home</a>
                <a onclick="window.location.href = '/account/'" class="nav-link d-flex align-items-center" aria-current="page" href="#">
                <i class="bi i-nav bi-person"></i>Account</a>
                <div class="">
                  <button class="btn-logout" onclick="logout()">logout</button>
                </div>
              </div>
            <div class="w-100 pb-4 gap-2 d-flex flex-column" id="accountBody">
            </div>
          </div>
        </nav>
        
        
        <div class="w-100 pt-5 px-3 overflow-x-hidden position-relative" id="chatBody" style="height:87vh;">
          <div class="flex-column w-100" style="height:80vh; display:flex;" id="fakeLoadChat">
          <div class="bubble py-5">
            <div id="bl" ></div>
            <div class="txt px-3">
              <p class="message"></p>
              <span class="timestamp"></span>
            </div>
            <div class="bubble-arrow"></div>
          </div>
          <div class="bubble py-3">
            <div id="bl" ></div>
            <div class="txt px-3">
              <p class="message"></p>
              <span class="timestamp"></span>
            </div>
            <div class="bubble-arrow"></div>
          </div>
          <div class="bubble py-5">
            <div id="bl" ></div>
            <div class="txt px-3">
              <p class="message"></p>
              <span class="timestamp"></span>
            </div>
            <div class="bubble-arrow"></div>
          </div>
          <div class="bubble py-5">
            <div id="bl" ></div>
            <div class="txt px-3">
              <p class="message"></p>
              <span class="timestamp"></span>
            </div>
            <div class="bubble-arrow"></div>
          </div>
          <div class="bubble py-4">
            <div id="bl" ></div>
            <div class="txt px-3">
              <p class="message"></p>
              <span class="timestamp"></span>
            </div>
            <div class="bubble-arrow"></div>
          </div>
          <div class="bubble py-3">
            <div id="bl" ></div>
            <div class="txt px-3">
              <p class="message"></p>
              <span class="timestamp"></span>
            </div>
            <div class="bubble-arrow"></div>
          </div>
          <div class="bubble py-5">
            <div id="bl" ></div>
            <div class="txt px-3">
              <p class="message"></p>
              <span class="timestamp"></span>
            </div>
            <div class="bubble-arrow"></div>
          </div>
          </div>
        </div>
        
        
        
        
        <div class="fixed-bottom gap-2 d-flex p-2 w-100 bg-light" style="height:60px;">
          <textarea id="messageInput" class="w-75 border-2 border-dark rounded-2" style="height:100%:" placeholder="type your message in here.."></textarea>
          <button class="w-25 p-2 border-0 text-light bg-primary rounded-2" id="btnSend" onclick="sendMessage()">
            <i class="bi bi-arrow-up"></i>
        </div>
        
        
  <!--  area pop up -->
   <div class="w-100 justify-content-center align-items-center text-center position-fixed " style="height:100vh;backdrop-filter:blur(5px);z-index:9999; display:none;" id="popupLoginSign">
     <div class="bg-light text-dark text-center d-flex flex-column justify-content-center align-items-center rounded-2" id="contain-login" style="width:300px;height:400px;box-shadow:0 0 5px rgba(0,0,0,.5)">
       <div class="px-5 flex-column" id="viewLogin" style="display:flex;">
       <h1 class="fw-bold">Login</h1>
       <p class="m-0 px-3">kamu belum login, ayo login atau buat akun terlebih dahulu</p>
       <div class="d-flex mt-3 flex-column gap-3">
       <input type="text" class="border-2 p-1 rounded-1 border-dark" name="" id="usn-login" value="" placeholder="username mu.." />
       <input type="text" class="bordep-1 rounded-1 p-1 border-dark" name="" id="pw-login" value="" placeholder="password mu.." />
       <button class="btn px-3 btn-primary text-light fw-bold" onclick="login()">Login</button>
       <div class="d-flex justify-content-center align-items-center">
       <p class="m-0">belum punya akun?</p><div class="ahref" onclick="showSign()">daftar</div>
       </div>
       
       </div>
       </div>
       <div class="px-5 flex-column" id="viewSign" style="display:none;">
       <h1 class="fw-bold">Sign-up</h1>
       <p class="m-0 px-3">kamu belum login, ayo login atau buat akun terlebih dahulu</p>
       <form id="formSign" class="d-flex mt-3 flex-column gap-3">
         <div class="w-100 d-flex flex-column align-items-center justify-content-center" onclick="document.getElementById('inputProfile').click();">
         <img src="default.png" class="" style="width:80px;border-radius:50%;" alt="">
         <i class="bi bi-pencil-square"></i>
       <input type="file" name="" id="inputProfile" hidden value="" />
         </div>
       <input type="text" class="border-2 p-1 rounded-1 border-dark" name="" id="usn-sign" value="" placeholder="username mu.." />
       <input type="text" class="border-2 p-1 rounded-1 border-dark" name="" id="role-sign" value="" placeholder="role atau job mu.." />
       <input type="text" class="border-2 p-1 rounded-1 border-dark" name="" id="bio-sign" value="" placeholder="bio akun mu.. (optional)" />
       <input type="number" class="border-2 p-1 rounded-1 border-dark" name="" id="contact-sign" value="" placeholder="nomor Whatsapp mu.. ex 628777..." />
       <div class="d-flex">
         <input type="text" class="border-2 p-1 rounded-1 border-dark" disabled placeholder="color favorite mu..">
       <input type="color" class="border-2 p-1 m-0 rounded-1 border-dark" name="" id="colorFavUser" value="" />
       </div>
       <input type="text" class="bordep-1 rounded-1 p-1 border-dark" name="" id="pw-sign" value="" placeholder="password mu.." />
       <button class="btn px-3 btn-primary text-light fw-bold" id="btn-sign" type="submit">Buat akun</button>
       <div class="d-flex justify-content-center align-items-center">
       <p class="m-0">sudah punya akun?</p><div class="ahref" onclick="showLogin()">Login</div>
       </div>
       
     </form>
   </i>
       </i>
       </i>
   
   
   
   <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
   <script src="main.js" type="text/javascript"></script>
<script src="https://www.gstatic.com/firebasejs/9.12.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.12.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.12.1/firebase-storage-compat.js"></script>
  <script>
// initialize fb via chat realtime
const firebaseConfig = {
    databaseURL: "https://chatzer-lite-default-rtdb.firebaseio.com/",
    storageBucket: "gs://chatzer-lite.appspot.com"
}
firebase.initializeApp(firebaseConfig)

const database = firebase.database();
const storage = firebase.storage();

function getMess() {
    const chatBody = document.getElementById('chatBody');
    const fakeLoad = document.getElementById('fakeLoadChat');

    // Mendapatkan username pengguna saat ini
    const currentUser = localStorage.getItem('usn');

    // Fetch data profil pengguna saat ini
    fetch(urlFb + 'account.json')
        .then(res => res.json())
        .then(accountData => {
            // Fetch data pesan dari Firebase Realtime Database secara realtime
            database.ref('message').on('value', snapshot => {
                fakeLoad.style.display = 'none';
                chatBody.innerHTML = '';
                snapshot.forEach(childSnapshot => {
                    const val = childSnapshot.val();
                    const id = val.id;
                    const usn = val.username;
                    const role = val.role;
                    const contact = val.contact;
                    const message = val.message;
                    const dateSended = val.date;
                    const color = val.color;

                    // Cari URL gambar profil pengguna yang sesuai dengan pengirim pesan
                    const profileData = Object.values(accountData).find(profile => profile.username === usn);
                    const profileSrc = profileData ? profileData.profileImageUrl : 'default.png';

                    const chatAppend = document.createElement("div");
                    chatAppend.classList.add('d-flex');
                    chatAppend.classList.add('position-relative');
                    chatAppend.innerHTML = `
                        <div class="bubble py-2 ${usn === currentUser ? 'self' : ''}">
                            <div class="d-flex w-100 gap-3 position-relative px-3">
                                <p class="name ${usn === currentUser ? 'd-none' : ''}" style="color: ${color} !important;">${usn} (${role})</p>
                                <p class="name ${usn === currentUser ? 'd-flex' : 'd-none'}" style="color: white !important;">You</p>
                                <p class="name position-absolute" style="right:10px; color: ${usn === currentUser ? '#eaeaea' : ''} !important;" onclick="window.location.href = 'https://wa.me/${contact}/'">+${contact}</p>  
                            </div>
                            <div class="txt px-3">
                                <p class="message ${usn === currentUser ? 'text-light' : ''}"></p>
                                <span class="timestamp" style=" color: ${usn === currentUser ? '#eaeaea' : ''} !important;">${dateSended}</span>
                            </div>
                            <div class="bubble-arrow ${usn === currentUser ? 'd-none' : ''}"></div>
                            <div class="bubble-arrow-right ${usn === currentUser ? 'd-flex' : 'd-none'}"></div>
                        </div>
                        <div class="position-absolute" style="bottom:18px; ${usn === currentUser ? 'right' : 'left'}:-15px; width: 25px; height: 25px; border-radius: 50%; background: url('${profileSrc}') center/cover;">
                        </div>
                    `;
                    chatAppend.querySelector(".message").textContent = message;
                    chatBody.appendChild(chatAppend);
                    chatBody.scrollTop = chatBody.scrollHeight;
                });
            });
        })
        .catch(error => console.error(error.message));
}

getMess();

// handle sign - in
const formSign = document.getElementById('formSign');
formSign.addEventListener("submit", (e) => {
    e.preventDefault();
    const btnSign = document.getElementById('btn-sign');
    btnSign.innerHTML = '<div class="spinner-border text-light" role="status" style="width:20px;height:20px;"></div>';
    btnSign.setAttribute('disabled', true);
    const usnSign = document.getElementById('usn-sign');
    const roleSign = document.getElementById('role-sign');
    const bioSign = document.getElementById('bio-sign');
    const contactSign = document.getElementById('contact-sign');
    const pwSign = document.getElementById('pw-sign');
    const valColor = document.getElementById('colorFavUser');

    if (usnSign.value && roleSign.value && contactSign.value && pwSign.value) {
        if (pwSign.value.length < 8) {
            alert('jumlah password kurang kuat (min 8)');
            btnSign.innerHTML = 'Buat akun';
            btnSign.removeAttribute('disabled');
            return;
        }

        // Mendapatkan file dari input file
        const file = document.getElementById('inputProfile').files[0];

        if (file) {
            const fileName = Date.now() + '_' + file.name;
            const storageRef = firebase.storage().ref();
            const uploadTask = storageRef.child('profileImages/' + fileName).put(file);

            uploadTask.on('state_changed', 
                (snapshot) => {
                },
                (error) => {
                    console.error('Error uploading profile image:', error);
                },
                () => {
                    uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                      
                    fetch(urlFb + 'account.json')
                    .then(res => res.json())
                    .then(data => {
                    let lastIndex = 0;
                  for (const key in data) {
                      lastIndex++;
                  }
                    const newId = lastIndex + 1;
                    const formVal = {
                            id: newId,
                            username: usnSign.value,
                            role: roleSign.value,
                            bio: bioSign.value,
                            contact: contactSign.value,
                            password: pwSign.value,
                            colorFavorite: valColor.value,
                            profileImageUrl: downloadURL,
                            status: "offline"
                        };

                        // Kirim data ke Firebase
                        fetch(urlFb + 'account.json', {
                            method: "POST",
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(formVal)
                        })
                        .then(response => {
                            if (response.ok) {
                                alert('Berhasil membuat akun! sekarang login.');
                                location.reload();
                            } else {
                                throw new Error('Gagal menyimpan data.');
                            }
                        })
                        .catch(error => {
                            alert('Terjadi kesalahan: ' + error.message);
                        });
          })
          .catch(e => console.error(err.message))
                    });
                }
            );
        } else {
          fetch(urlFb + 'account.json')
          .then(res => res.json())
          .then(data => {
          let lastIndex = 0;
        for (const key in data) {
            lastIndex++;
        }
        const newId = lastIndex + 1;
            const formVal = {
                id: newId,
                username: usnSign.value,
                role: roleSign.value,
                bio: bioSign.value,
                contact: contactSign.value,
                password: pwSign.value,
                colorFavorite: valColor.value,
                profileImageUrl: 'https://firebasestorage.googleapis.com/v0/b/chatzer-lite.appspot.com/o/default.png?alt=media&token=81784069-6b43-476a-a92d-7d781addfadf',
                status: "offline"
              };

            // Kirim data ke Firebase
            fetch(urlFb + 'account.json', {
                method: "POST",
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formVal)
            })
            .then(response => {
                if (response.ok) {
                    alert('Berhasil membuat akun! sekarang login.');
                    location.reload();
                } else {
                    throw new Error('Gagal menyimpan data.');
                }
            })
            .catch(error => {
                alert('Terjadi kesalahan: ' + error.message);
            });
          })
          .catch(e => console.error(err.message))
        }
    } else {
        alert('Semua input harus di isi!');   
        btnSign.innerHTML = 'Buat akun';
        btnSign.removeAttribute('disabled');
        
    }
});

  </script>
  </body>
</html>
